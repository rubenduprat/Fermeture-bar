<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Fermeture Dynamique</title>
    <style>
        :root {
            --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60;
            --whatsapp: #25D366; --photo: #3498db; --bg: #f4f7f6;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 600px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .progress-container { position: sticky; top: 0; background: white; padding: 10px 0; z-index: 100; border-bottom: 2px solid #eee; }
        .progress-bar { width: 100%; height: 15px; background: #eee; border-radius: 10px; margin-top: 5px; }
        #progress-fill { width: 0%; height: 100%; background: var(--success); transition: width 0.3s; border-radius: 10px; }
        h2 { background: var(--primary); color: white; padding: 10px; font-size: 1rem; border-radius: 5px; margin-top: 20px; }
        .task-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .done { text-decoration: line-through; color: #95a5a6; opacity: 0.6; }
        input[type="checkbox"] { width: 22px; height: 22px; margin-right: 12px; cursor: pointer; }
        textarea { width: 100%; height: 80px; margin-top: 15px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn-group { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        button { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-photo { background: var(--photo); color: white; }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .btn-reset { background: #95a5a6; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="progress-container">
        <strong>Progression : <span id="stat-perc">0%</span></strong>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <h1>Fermeture Bar</h1>

    <div id="checklist-content">
        <p>Chargement des t√¢ches...</p>
    </div>

    <h3>üìù Notes / Incidents</h3>
    <textarea id="notes" placeholder="Rien √† signaler..."></textarea>

    <div class="btn-group">
        <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display: none;">
        <button class="btn-photo" onclick="document.getElementById('cameraInput').click()">üì∏ PRENDRE UNE PHOTO</button>
        <button id="send-btn" class="btn-whatsapp" onclick="sendWhatsApp()">üü¢ ENVOYER SUR WHATSAPP</button>
        <button class="btn-reset" onclick="resetForm()">üîÑ RESET (Nouveau service)</button>
    </div>
</div>

<script>
    const checklistContent = document.getElementById('checklist-content');
    const notes = document.getElementById('notes');
    const fill = document.getElementById('progress-fill');
    const perc = document.getElementById('stat-perc');
    let checkboxes = [];

    // CHARGEMENT DU JSON
    async function loadTasks() {
        try {
            const response = await fetch('tasks.json');
            if (!response.ok) throw new Error();
            const data = await response.json();
            renderTasks(data);
        } catch (e) {
            checklistContent.innerHTML = "<p style='color:red'>‚ö†Ô∏è Erreur: Assurez-vous que 'tasks.json' est bien dans le m√™me dossier.</p>";
        }
    }

    function renderTasks(data) {
        let html = "";
        data.forEach(section => {
            html += `<h2>${section.categorie}</h2>`;
            section.items.forEach(task => {
                html += `<label class="task-item"><input type="checkbox" data-task="${task}"> ${task}</label>`;
            });
        });
        checklistContent.innerHTML = html;
        checkboxes = document.querySelectorAll('input[type="checkbox"]');
        setupApp();
    }

    function setupApp() {
        checkboxes.forEach((cb, index) => {
            const saved = localStorage.getItem('bar-task-' + index);
            if (saved === 'true') cb.checked = true;
            cb.addEventListener('change', () => {
                localStorage.setItem('bar-task-' + index, cb.checked);
                updateProgress();
            });
        });
        notes.value = localStorage.getItem('bar-notes') || "";
        updateProgress();
    }

    function updateProgress() {
        const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
        const total = checkboxes.length;
        const progress = total > 0 ? Math.round((checked / total) * 100) : 0;
        fill.style.width = progress + '%';
        perc.innerText = progress + '%';
        checkboxes.forEach(cb => cb.parentElement.classList.toggle('done', cb.checked));
    }

    function resetForm() {
        if (confirm("‚ö†Ô∏è R√©initialiser la fiche ?")) {
            localStorage.clear();
            location.reload();
        }
    }

    function sendWhatsApp() {
        const phoneNumber = "33600000000"; 
        const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        const progress = Math.round((checkedCount / checkboxes.length) * 100);

        if (progress < 100 && !confirm(`‚ö†Ô∏è Fermeture √† ${progress}%. Envoyer ?`)) return;

        const now = new Date();
        const dateStr = now.toLocaleDateString('fr-FR', {weekday: 'long', day: 'numeric', month: 'short'});
        const timeStr = now.getHours() + "h" + now.getMinutes().toString().padStart(2, '0');
        
        let taskList = "";
        checkboxes.forEach(cb => {
            taskList += (cb.checked ? "‚úÖ " : "‚ùå ") + cb.getAttribute('data-task') + "\n";
        });

        const rapportNotes = notes.value.trim() || "Rien √† signaler.";
        const message = `*üèÅ RAPPORT DE FERMETURE BAR*\n_Le ${dateStr} √† ${timeStr}_\n\n*üìä STATUT : ${progress}%*\n\n*D√âTAIL :*\n${taskList}\n*üìù NOTES :*\n"${rapportNotes}"`;

        window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
    }

    notes.addEventListener('input', () => localStorage.setItem('bar-notes', notes.value));
    loadTasks();
</script>
</body>
</html>

